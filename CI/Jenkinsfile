pipeline {
    agent any  // åœ¨ä»»æ„å¯ç”¨çš„æœºå™¨ä¸Šè¿è¡Œ
    
    stages {
        // ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ï¼ˆç”¨CMakeè®¾ç½®é¡¹ç›®ï¼‰
        stage('å‡†å¤‡') {
            steps {
                echo 'ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ„å»ºæ–‡ä»¶å¤¹...'
                sh '''
                    # åˆ é™¤æ—§çš„æ„å»ºæ–‡ä»¶å¤¹ï¼ˆå¦‚æœæœ‰ï¼‰
                    rm -rf build
                    # åˆ›å»ºæ–°çš„æ„å»ºæ–‡ä»¶å¤¹
                    mkdir build
                '''
            }
        }
        
        // ç¬¬äºŒæ­¥ï¼šç”¨CMakeé…ç½®é¡¹ç›®
        stage('é…ç½®') {
            steps {
                echo 'ç¬¬äºŒæ­¥ï¼šç”¨CMakeé…ç½®é¡¹ç›®...'
                sh '''
                    cd build
                    cmake ..   # å‘Šè¯‰CMakeé¡¹ç›®åœ¨ä¸Šä¸€çº§ç›®å½•
                '''
            }
        }
        
        // ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘é¡¹ç›®
        stage('ç¼–è¯‘') {
            steps {
                echo 'ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘Cä»£ç ...'
                sh '''

                    cd build
                    cmake --build .       # ç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
                '''
            }
            
            post {
                success {
                    // æŸ¥çœ‹ç”Ÿæˆäº†ä»€ä¹ˆæ–‡ä»¶
                    sh '''
                        echo "ç¼–è¯‘æˆåŠŸï¼ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
                        ls -la build/
                        # å¦‚æœæœ‰å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¾ç¤ºå®ƒ
                        if [ -f "build/bin/oftp-dtp" ]; then
                            echo "æ‰¾åˆ°äº†å¯æ‰§è¡Œæ–‡ä»¶ï¼šbuild/bin/oftp-dtp"
                        fi
                    '''
                }
            }
        }
        
        // ç¬¬å››æ­¥ï¼šè¿è¡Œæµ‹è¯•
        stage('æµ‹è¯•') {
            steps {
                echo 'ç¬¬å››æ­¥ï¼šè¿è¡Œæµ‹è¯•...'
                sh '''
                    cd build/test
                    # å¦‚æœæœ‰æµ‹è¯•ï¼Œå°±è¿è¡Œæµ‹è¯•
                    if [ -f "ftest" ]; then
                        ./ftest
                        echo "âœ… æµ‹è¯•é€šè¿‡ï¼"
                    else
                        echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•ç¨‹åºï¼Œè·³è¿‡æµ‹è¯•"
                    fi
                '''
            }
        }
    }
    
    // æ•´ä¸ªæµæ°´çº¿ç»“æŸååšä»€ä¹ˆ
    post {
        success {
            echo 'ğŸ‰ æ­å–œï¼æ„å»ºå’Œæµ‹è¯•éƒ½æˆåŠŸäº†ï¼'
        }
        failure {
            echo 'âŒ å‡ºé”™äº†ï¼è¯·æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯'
        }
    }
}